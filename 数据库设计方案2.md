# æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ2

## è®¾è®¡æ€è·¯
1. å‡å°‘è¡¨çš„æ•°é‡ï¼Œå°†ç›¸å…³æ•°æ®åˆå¹¶
2. ä½¿ç”¨ JSON ç±»å‹å­˜å‚¨éå…³ç³»å‹æ•°æ®
3. ç®€åŒ–å¤–é”®å…³ç³»
4. ä½¿ç”¨è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤è®¡æ•°å­—æ®µ

## å½“å‰è¡¨ç»“æ„

### 1. users è¡¨
```sql
CREATE TABLE users (
  user_id TEXT PRIMARY KEY,
  name TEXT,
  avatar TEXT,
  style_description TEXT,
  gender TEXT,
  background_story TEXT,
  interest_tags JSONB,
  favorites JSONB,  -- æ”¶è—çš„æ–‡ç« IDæ•°ç»„
  liked_articles JSONB,  -- ç‚¹èµçš„æ–‡ç« IDæ•°ç»„
  followers JSONB,  -- å…³æ³¨è€…ä¿¡æ¯æ•°ç»„
  following JSONB,  -- æ­£åœ¨å…³æ³¨çš„ç”¨æˆ·ä¿¡æ¯æ•°ç»„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2. articles è¡¨
```sql
CREATE TABLE articles (
  article_id BIGINT PRIMARY KEY,
  user_id TEXT REFERENCES users(user_id),
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  level TEXT,
  topic TEXT,
  vocabularies JSONB,  -- å•è¯æ•°ç»„
  key_phrases JSONB,   -- çŸ­è¯­æ•°ç»„
  learning_points JSONB, -- å­¦ä¹ è¦ç‚¹æ•°ç»„
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 3. interactions è¡¨
```sql
-- äº’åŠ¨ç±»å‹æšä¸¾
CREATE TYPE interaction_type AS ENUM ('like', 'favorite', 'comment', 'reply');

CREATE TABLE interactions (
  interaction_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT REFERENCES users(user_id),
  article_id BIGINT REFERENCES articles(article_id),
  target_user_id TEXT REFERENCES users(user_id),
  parent_interaction_id UUID REFERENCES interactions(interaction_id),
  type interaction_type NOT NULL,
  content TEXT,
  translation TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  -- çº¦æŸæ¡ä»¶
  CONSTRAINT valid_reply CHECK (
    (type = 'reply' AND parent_interaction_id IS NOT NULL) OR
    (type != 'reply' AND parent_interaction_id IS NULL)
  ),
  CONSTRAINT valid_content CHECK (
    (type IN ('comment', 'reply') AND content IS NOT NULL) OR
    (type IN ('like', 'favorite'))
  ),
  CONSTRAINT valid_target_user CHECK (
    (type = 'reply' AND target_user_id IS NOT NULL) OR
    (type != 'reply' AND target_user_id IS NULL)
  )
);

-- ç´¢å¼•
CREATE INDEX idx_interactions_article_id ON interactions(article_id);
CREATE INDEX idx_interactions_user_id ON interactions(user_id);
CREATE INDEX idx_interactions_type ON interactions(type);
CREATE INDEX idx_interactions_created_at ON interactions(created_at);
```

## æ•°æ®ç»“æ„ç¤ºä¾‹

### users è¡¨æ•°æ®ç¤ºä¾‹
```json
{
  "user_id": "u1",
  "name": "Emma Chen",
  "avatar": "ğŸ‘©ğŸ»â€ğŸ’¼",
  "style_description": "çƒ­çˆ±å­¦ä¹ çš„èŒåœºè¾¾äººï¼Œæ“…é•¿è·¨æ–‡åŒ–äº¤é™…",
  "gender": "female",
  "background_story": "Emma æ˜¯ä¸€ååœ¨è·¨å›½å…¬å¸å·¥ä½œçš„äº§å“ç»ç†ï¼Œæ¯å¤©éƒ½éœ€è¦å’Œæ¥è‡ªä¸åŒå›½å®¶çš„åŒäº‹äº¤æµã€‚é€šè¿‡ä¸æ–­å­¦ä¹ å’Œå®è·µï¼Œå¥¹çš„è‹±è¯­å£è¯­æ°´å¹³æœ‰äº†æ˜¾è‘—æé«˜ã€‚",
  "interest_tags": ["èŒåœºäº¤é™…", "å•†åŠ¡è‹±è¯­", "æ—¥å¸¸ç”Ÿæ´»"],
  "favorites": ["1", "2"],
  "liked_articles": ["1"],
  "followers": [
    {
      "user_id": "u2",
      "name": "Michael Zhang",
      "avatar": "ğŸ‘¨ğŸ»â€ğŸ’»",
      "follow_time": "2024-02-01T10:00:00Z"
    }
  ],
  "following": [
    {
      "user_id": "u4",
      "name": "David Liu",
      "avatar": "ğŸ‘¨ğŸ»â€ğŸš€",
      "follow_time": "2024-02-03T09:15:00Z"
    }
  ]
}
```

### articles è¡¨æ•°æ®ç¤ºä¾‹
```json
{
  "article_id": 1,
  "title": "é€‰æ‹©é¤å…çš„å‹å¥½äº‰è®º",
  "content": "Sarah: How about Italian food? I know a great pasta place nearby!...",
  "level": "B1",
  "topic": "æ—¥å¸¸ç”Ÿæ´»",
  "vocabularies": [
    {
      "word": "cuisine",
      "phonetic": "/kwÉªËˆziËn/",
      "meaning": "çƒ¹é¥ªé£æ ¼ï¼›èœç³»",
      "example": "I was thinking Asian cuisine.",
      "translation": "æˆ‘åœ¨æƒ³åƒäºšæ´²èœã€‚"
    }
  ],
  "key_phrases": [
    {
      "phrase": "How about...?",
      "meaning": "ç”¨äºæå‡ºå»ºè®®",
      "category": "expression",
      "example": "How about Italian food?",
      "translation": "æ„å¤§åˆ©èœæ€ä¹ˆæ ·ï¼Ÿ"
    }
  ],
  "learning_points": [
    "åœ¨è¡¨è¾¾ä¸åŒæ„è§æ—¶ï¼Œä½¿ç”¨ 'Actually...' æ¥å§”å©‰å¼€åœº",
    "ç”¨ 'you make a good point' æ¥è‚¯å®šå¯¹æ–¹çš„è§‚ç‚¹"
  ]
}
```

## è®¾è®¡è¯´æ˜

1. ç”¨æˆ·äº’åŠ¨ï¼ˆç‚¹èµã€æ”¶è—ï¼‰ç›®å‰å­˜å‚¨åœ¨ users è¡¨çš„ JSON å­—æ®µä¸­
2. éœ€è¦åˆ›å»º interactions è¡¨æ¥æ”¹è¿›äº’åŠ¨åŠŸèƒ½çš„å®ç°
3. articles è¡¨çš„ article_id ä½¿ç”¨ BIGINT ç±»å‹
4. users è¡¨çš„ user_id ä½¿ç”¨ TEXT ç±»å‹
5. æ‰€æœ‰è¡¨éƒ½åŒ…å« created_at æ—¶é—´æˆ³
6. ä½¿ç”¨ JSONB ç±»å‹å­˜å‚¨æ•°ç»„å’Œå¤æ‚å¯¹è±¡æ•°æ®

## å¾…ä¼˜åŒ–é¡¹

1. ä» users è¡¨ä¸­ç§»é™¤ favorites å’Œ liked_articles å­—æ®µï¼Œæ”¹ç”¨ interactions è¡¨
2. æ·»åŠ æ–‡ç« äº’åŠ¨è®¡æ•°ï¼ˆlikes_count, favorites_count, comments_countï¼‰
3. å®ç°è¯„è®ºå’Œå›å¤åŠŸèƒ½
4. ä¼˜åŒ–ç”¨æˆ·å…³æ³¨å…³ç³»çš„å­˜å‚¨æ–¹å¼

## è®¾è®¡ä¼˜ç‚¹
1. ä½¿ç”¨ JSONB ç±»å‹çµæ´»å­˜å‚¨ç»“æ„åŒ–æ•°æ®
2. é€šè¿‡è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤è®¡æ•°å­—æ®µ
3. ç»Ÿä¸€çš„äº’åŠ¨è¡¨è®¾è®¡ï¼Œæ”¯æŒå¤šç§äº’åŠ¨ç±»å‹
4. å®Œæ•´çš„çº¦æŸç¡®ä¿æ•°æ®ä¸€è‡´æ€§
5. åˆç†çš„ç´¢å¼•è®¾è®¡æå‡æŸ¥è¯¢æ€§èƒ½

## è®¾è®¡ç¼ºç‚¹
1. JSONB å­—æ®µä¸æ”¯æŒå±€éƒ¨ç´¢å¼•
2. å¤æ‚çš„è¯„è®ºæ ‘æŸ¥è¯¢å¯èƒ½å½±å“æ€§èƒ½
3. è§¦å‘å™¨ç»´æŠ¤è®¡æ•°å¯èƒ½åœ¨é«˜å¹¶å‘æ—¶æœ‰æ€§èƒ½å½±å“

## æ³¨æ„äº‹é¡¹
1. éœ€è¦å®šæœŸç»´æŠ¤ JSONB å­—æ®µçš„æ•°æ®è´¨é‡
2. è¯„è®ºæ ‘æŸ¥è¯¢å»ºè®®å¢åŠ æ·±åº¦é™åˆ¶
3. è€ƒè™‘æ·»åŠ é€‚å½“çš„æƒé™æ§åˆ¶
4. å¯ä»¥è€ƒè™‘ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–çƒ­é—¨æ–‡ç« çš„è®¡æ•°æŸ¥è¯¢ 